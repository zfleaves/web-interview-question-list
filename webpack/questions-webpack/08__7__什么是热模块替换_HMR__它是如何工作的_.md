## 7. 什么是热模块替换（HMR）？它是如何工作的？

**答案：**

### HMR 简介

热模块替换（Hot Module Replacement）是 Webpack 提供的一种功能，可以在不刷新页面的情况下更新模块。

### HMR 的好处

1. **保留应用状态**
   - 不刷新页面
   - 保留当前的应用状态

2. **提高开发效率**
   - 实时预览修改
   - 减少等待时间

3. **提升开发体验**
   - 实时反馈
   - 快速迭代

### HMR 工作原理

```
1. 文件变化
   ├── Webpack 监听文件变化
   └── 重新编译变化的模块

2. 生成更新
   ├── 生成新的模块代码
   └── 生成更新清单（Manifest）

3. 通知客户端
   ├── 通过 WebSocket 发送更新通知
   └── 发送更新清单

4. 客户端接收更新
   ├── 接收更新通知
   └── 请求更新的模块

5. 替换模块
   ├── 使用新的模块替换旧模块
   └── 执行模块的 HMR 代码

6. 更新界面
   ├── 更新 DOM
   └── 保留应用状态
```

### HMR 配置

```javascript
const webpack = require('webpack');

module.exports = {
  mode: 'development',
  devServer: {
    hot: true,  // 启用 HMR
    open: true  // 自动打开浏览器
  },
  plugins: [
    new webpack.HotModuleReplacementPlugin()  // HMR 插件
  ]
};
```

### HMR API

```javascript
// 检测模块是否支持 HMR
if (module.hot) {
  // 接受当前模块的更新
  module.hot.accept();

  // 接受依赖模块的更新
  module.hot.accept('./dependency', () => {
    // 依赖模块更新后的回调
    console.log('Dependency updated');
  });

  // 处理更新错误
  module.hot.dispose(() => {
    // 清理工作
    console.log('Module disposed');
  });
}
```

### React HMR

```javascript
// React Fast Refresh
// 安装：npm install @pmmmwh/react-refresh-webpack-plugin react-refresh

const ReactRefreshWebpackPlugin = require('@pmmmwh/react-refresh-webpack-plugin');

module.exports = {
  mode: 'development',
  devServer: {
    hot: true
  },
  plugins: [
    new ReactRefreshWebpackPlugin()
  ],
  module: {
    rules: [
      {
        test: /\.jsx?$/,
        exclude: /node_modules/,
        use: {
          loader: 'babel-loader',
          options: {
            plugins: ['react-refresh/babel']
          }
        }
      }
    ]
  }
};
```

### Vue HMR

```javascript
// Vue Loader 默认支持 HMR
module.exports = {
  mode: 'development',
  devServer: {
    hot: true
  },
  module: {
    rules: [
      {
        test: /\.vue$/,
        loader: 'vue-loader'
      }
    ]
  }
};
```

### HMR 注意事项

1. **CSS HMR**
   ```javascript
   // CSS 默认支持 HMR
   module.exports = {
     module: {
       rules: [
         {
           test: /\.css$/,
           use: [
             'style-loader',  // 支持 HMR
             'css-loader'
           ]
         }
       ]
     }
   };
   ```

2. **生产环境不启用 HMR**
   ```javascript
   module.exports = {
     mode: 'production',  // 生产环境不启用 HMR
     devServer: {
       hot: false
     }
   };
   ```

---