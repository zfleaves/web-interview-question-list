# 4. 实现一个一致性哈希

**答案：**

```javascript
// 一致性哈希实现
class ConsistentHash {
  constructor(virtualNodes = 150) {
    this.virtualNodes = virtualNodes;
    this.ring = new Map();
    this.sortedKeys = [];
  }
  
  // 添加节点
  addNode(node) {
    for (let i = 0; i < this.virtualNodes; i++) {
      const virtualNodeKey = `${node}:${i}`;
      const hash = this._hash(virtualNodeKey);
      this.ring.set(hash, node);
      this.sortedKeys.push(hash);
    }
    
    this.sortedKeys.sort((a, b) => a - b);
  }
  
  // 移除节点
  removeNode(node) {
    for (let i = 0; i < this.virtualNodes; i++) {
      const virtualNodeKey = `${node}:${i}`;
      const hash = this._hash(virtualNodeKey);
      this.ring.delete(hash);
      
      const index = this.sortedKeys.indexOf(hash);
      if (index > -1) {
        this.sortedKeys.splice(index, 1);
      }
    }
  }
  
  // 获取节点
  getNode(key) {
    if (this.sortedKeys.length === 0) {
      return null;
    }
    
    const hash = this._hash(key);
    
    // 二分查找
    let left = 0;
    let right = this.sortedKeys.length - 1;
    
    while (left <= right) {
      const mid = Math.floor((left + right) / 2);
      
      if (this.sortedKeys[mid] === hash) {
        return this.ring.get(hash);
      } else if (this.sortedKeys[mid] < hash) {
        left = mid + 1;
      } else {
        right = mid - 1;
      }
    }
    
    // 如果没找到，返回第一个节点（环形）
    if (left >= this.sortedKeys.length) {
      return this.ring.get(this.sortedKeys[0]);
    }
    
    return this.ring.get(this.sortedKeys[left]);
  }
  
  // 哈希函数
  _hash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return Math.abs(hash);
  }
}
```

---

## 场景题
