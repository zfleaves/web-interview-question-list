# 9. 如何判断用户设备？

**答案：**

判断用户设备是前端开发中的常见需求，用于实现响应式设计、设备适配等功能。

**实现方案：**

**方案 1：基于 User-Agent 判断**
```javascript
class DeviceDetector {
  constructor() {
    this.userAgent = navigator.userAgent;
    this.device = this.detectDevice();
    this.os = this.detectOS();
    this.browser = this.detectBrowser();
  }
  
  detectDevice() {
    const ua = this.userAgent;
    
    // 移动设备
    if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated/.test(ua)) {
      return 'mobile';
    }
    
    // 平板设备
    if (/Tablet|iPad/i.test(ua)) {
      return 'tablet';
    }
    
    // 桌面设备
    return 'desktop';
  }
  
  detectOS() {
    const ua = this.userAgent;
    
    if (/Windows/i.test(ua)) {
      return 'windows';
    }
    
    if (/Mac OS|Macintosh/i.test(ua)) {
      return 'macos';
    }
    
    if (/Linux/i.test(ua)) {
      return 'linux';
    }
    
    if (/Android/i.test(ua)) {
      return 'android';
    }
    
    if (/iOS|iPhone|iPad|iPod/i.test(ua)) {
      return 'ios';
    }
    
    return 'unknown';
  }
  
  detectBrowser() {
    const ua = this.userAgent;
    
    if (/Chrome/i.test(ua) && !/Edge|OPR/i.test(ua)) {
      return 'chrome';
    }
    
    if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) {
      return 'safari';
    }
    
    if (/Firefox/i.test(ua)) {
      return 'firefox';
    }
    
    if (/Edge/i.test(ua)) {
      return 'edge';
    }
    
    if (/MSIE|Trident/i.test(ua)) {
      return 'ie';
    }
    
    return 'unknown';
  }
  
  isMobile() {
    return this.device === 'mobile';
  }
  
  isTablet() {
    return this.device === 'tablet';
  }
  
  isDesktop() {
    return this.device === 'desktop';
  }
  
  isIOS() {
    return this.os === 'ios';
  }
  
  isAndroid() {
    return this.os === 'android';
  }
}

// 使用
const detector = new DeviceDetector();

console.log('设备类型:', detector.device);
console.log('操作系统:', detector.os);
console.log('浏览器:', detector.browser);

if (detector.isMobile()) {
  // 移动端逻辑
  console.log('当前是移动设备');
}
```

**方案 2：基于屏幕尺寸判断**
```javascript
class ResponsiveDetector {
  constructor() {
    this.breakpoints = {
      mobile: 768,
      tablet: 1024,
      desktop: 1440
    };
    
    this.currentBreakpoint = this.getCurrentBreakpoint();
    this.init();
  }
  
  getCurrentBreakpoint() {
    const width = window.innerWidth;
    
    if (width < this.breakpoints.mobile) {
      return 'mobile';
    } else if (width < this.breakpoints.tablet) {
      return 'tablet';
    } else if (width < this.breakpoints.desktop) {
      return 'desktop';
    } else {
      return 'large';
    }
  }
  
  init() {
    window.addEventListener('resize', this.handleResize.bind(this));
  }
  
  handleResize() {
    const newBreakpoint = this.getCurrentBreakpoint();
    
    if (newBreakpoint !== this.currentBreakpoint) {
      const oldBreakpoint = this.currentBreakpoint;
      this.currentBreakpoint = newBreakpoint;
      
      // 触发断点变化事件
      this.onBreakpointChange(oldBreakpoint, newBreakpoint);
    }
  }
  
  onBreakpointChange(oldBreakpoint, newBreakpoint) {
    console.log(`断点从 ${oldBreakpoint} 变为 ${newBreakpoint}`);
    
    // 可以在这里执行相应的逻辑
    if (newBreakpoint === 'mobile') {
      // 移动端逻辑
    }
  }
  
  destroy() {
    window.removeEventListener('resize', this.handleResize.bind(this));
  }
}

// 使用
const responsiveDetector = new ResponsiveDetector();
```

**方案 3：基于媒体查询判断**
```javascript
class MediaQueryDetector {
  constructor() {
    this.queries = {
      mobile: window.matchMedia('(max-width: 767px)'),
      tablet: window.matchMedia('(min-width: 768px) and (max-width: 1023px)'),
      desktop: window.matchMedia('(min-width: 1024px)'),
      portrait: window.matchMedia('(orientation: portrait)'),
      landscape: window.matchMedia('(orientation: landscape)'),
      darkMode: window.matchMedia('(prefers-color-scheme: dark)'),
      highDPI: window.matchMedia('(min-resolution: 2dppx)')
    };
    
    this.init();
  }
  
  init() {
    Object.keys(this.queries).forEach(key => {
      const query = this.queries[key];
      
      // 初始检查
      this.updateQueryStatus(key, query);
      
      // 监听变化
      query.addEventListener('change', (e) => {
        this.updateQueryStatus(key, e);
      });
    });
  }
  
  updateQueryStatus(key, query) {
    this[key] = query.matches;
    console.log(`${key}: ${query.matches}`);
  }
  
  isMobile() {
    return this.mobile;
  }
  
  isTablet() {
    return this.tablet;
  }
  
  isDesktop() {
    return this.desktop;
  }
  
  isPortrait() {
    return this.portrait;
  }
  
  isLandscape() {
    return this.landscape;
  }
  
  isDarkMode() {
    return this.darkMode;
  }
  
  isHighDPI() {
    return this.highDPI;
  }
}

// 使用
const mediaQueryDetector = new MediaQueryDetector();

if (mediaQueryDetector.isMobile()) {
  console.log('当前是移动设备');
}

if (mediaQueryDetector.isDarkMode()) {
  console.log('当前是深色模式');
}
```

**方案 4：使用 Modernizr 检测功能支持**
```javascript
class FeatureDetector {
  constructor() {
    this.features = {
      touch: this.detectTouch(),
      webGL: this.detectWebGL(),
      webWorker: this.detectWebWorker(),
      localStorage: this.detectLocalStorage(),
      sessionStorage: this.detectSessionStorage(),
      serviceWorker: this.detectServiceWorker(),
      webSocket: this.detectWebSocket(),
      geolocation: this.detectGeolocation(),
      camera: this.detectCamera(),
      microphone: this.detectMicrophone()
    };
  }
  
  detectTouch() {
    return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  }
  
  detectWebGL() {
    try {
      const canvas = document.createElement('canvas');
      return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
    } catch (e) {
      return false;
    }
  }
  
  detectWebWorker() {
    return 'Worker' in window;
  }
  
  detectLocalStorage() {
    try {
      localStorage.setItem('test', 'test');
      localStorage.removeItem('test');
      return true;
    } catch (e) {
      return false;
    }
  }
  
  detectSessionStorage() {
    try {
      sessionStorage.setItem('test', 'test');
      sessionStorage.removeItem('test');
      return true;
    } catch (e) {
      return false;
    }
  }
  
  async detectServiceWorker() {
    return 'serviceWorker' in navigator;
  }
  
  detectWebSocket() {
    return 'WebSocket' in window;
  }
  
  detectGeolocation() {
    return 'geolocation' in navigator;
  }
  
  async detectCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop());
      return true;
    } catch (e) {
      return false;
    }
  }
  
  async detectMicrophone() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => track.stop());
      return true;
    } catch (e) {
      return false;
    }
  }
  
  hasFeature(feature) {
    return this.features[feature];
  }
}

// 使用
const featureDetector = new FeatureDetector();

if (featureDetector.hasFeature('touch')) {
  console.log('支持触摸');
}

if (featureDetector.hasFeature('webGL')) {
  console.log('支持 WebGL');
}
```

---
