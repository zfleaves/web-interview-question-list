# 7. 如何实现一个电商购物车系统？

**答案：**

电商购物车系统需要考虑商品管理、价格计算、库存检查等多个方面。

**方案设计：**

**方案 1：基于 Redux 的购物车**
```javascript
// 购物车状态管理
const initialState = {
  items: [],
  total: 0,
  count: 0,
  loading: false,
  error: null
};

// Action Types
const ADD_TO_CART = 'ADD_TO_CART';
const REMOVE_FROM_CART = 'REMOVE_FROM_CART';
const UPDATE_QUANTITY = 'UPDATE_QUANTITY';
const CLEAR_CART = 'CLEAR_CART';
const APPLY_COUPON = 'APPLY_COUPON';

// Action Creators
export const addToCart = (product, quantity = 1) => ({
  type: ADD_TO_CART,
  payload: { product, quantity }
});

export const removeFromCart = (productId) => ({
  type: REMOVE_FROM_CART,
  payload: { productId }
});

export const updateQuantity = (productId, quantity) => ({
  type: UPDATE_QUANTITY,
  payload: { productId, quantity }
});

export const clearCart = () => ({
  type: CLEAR_CART
});

export const applyCoupon = (couponCode) => ({
  type: APPLY_COUPON,
  payload: { couponCode }
});

// Reducer
export default function cartReducer(state = initialState, action) {
  switch (action.type) {
    case ADD_TO_CART: {
      const { product, quantity } = action.payload;
      const existingItem = state.items.find(item => item.id === product.id);
      
      if (existingItem) {
        return {
          ...state,
          items: state.items.map(item =>
            item.id === product.id
              ? { ...item, quantity: item.quantity + quantity }
              : item
          ),
          ...calculateTotals(
            state.items.map(item =>
              item.id === product.id
                ? { ...item, quantity: item.quantity + quantity }
                : item
            )
          )
        };
      }
      
      return {
        ...state,
        items: [...state.items, { ...product, quantity }],
        ...calculateTotals([...state.items, { ...product, quantity }])
      };
    }
    
    case REMOVE_FROM_CART: {
      const { productId } = action.payload;
      const newItems = state.items.filter(item => item.id !== productId);
      
      return {
        ...state,
        items: newItems,
        ...calculateTotals(newItems)
      };
    }
    
    case UPDATE_QUANTITY: {
      const { productId, quantity } = action.payload;
      
      if (quantity <= 0) {
        const newItems = state.items.filter(item => item.id !== productId);
        return {
          ...state,
          items: newItems,
          ...calculateTotals(newItems)
        };
      }
      
      const newItems = state.items.map(item =>
        item.id === productId ? { ...item, quantity } : item
      );
      
      return {
        ...state,
        items: newItems,
        ...calculateTotals(newItems)
      };
    }
    
    case CLEAR_CART: {
      return initialState;
    }
    
    default:
      return state;
  }
}

// 计算总价和数量
function calculateTotals(items) {
  const total = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
  const count = items.reduce((sum, item) => sum + item.quantity, 0);
  
  return { total, count };
}

// 选择器
export const selectCartItems = state => state.cart.items;
export const selectCartTotal = state => state.cart.total;
export const selectCartCount = state => state.cart.count;
```

**方案 2：React Hooks 实现**
```javascript
import { useState, useEffect, useMemo } from 'react';

function useShoppingCart() {
  const [cart, setCart] = useState({
    items: [],
    coupon: null
  });
  
  // 计算总价
  const total = useMemo(() => {
    return cart.items.reduce((sum, item) => {
      return sum + item.price * item.quantity;
    }, 0);
  }, [cart.items]);
  
  // 计算折扣
  const discount = useMemo(() => {
    if (!cart.coupon) return 0;
    
    switch (cart.coupon.type) {
      case 'percentage':
        return total * (cart.coupon.value / 100);
      case 'fixed':
        return cart.coupon.value;
      default:
        return 0;
    }
  }, [total, cart.coupon]);
  
  // 最终价格
  const finalTotal = total - discount;
  
  // 添加商品
  const addToCart = (product, quantity = 1) => {
    setCart(prevCart => {
      const existingItem = prevCart.items.find(item => item.id === product.id);
      
      if (existingItem) {
        return {
          ...prevCart,
          items: prevCart.items.map(item =>
            item.id === product.id
              ? { ...item, quantity: item.quantity + quantity }
              : item
          )
        };
      }
      
      return {
        ...prevCart,
        items: [...prevCart.items, { ...product, quantity }]
      };
    });
  };
  
  // 移除商品
  const removeFromCart = (productId) => {
    setCart(prevCart => ({
      ...prevCart,
      items: prevCart.items.filter(item => item.id !== productId)
    }));
  };
  
  // 更新数量
  const updateQuantity = (productId, quantity) => {
    if (quantity <= 0) {
      removeFromCart(productId);
      return;
    }
    
    setCart(prevCart => ({
      ...prevCart,
      items: prevCart.items.map(item =>
        item.id === productId ? { ...item, quantity } : item
      )
    }));
  };
  
  // 应用优惠券
  const applyCoupon = (coupon) => {
    setCart(prevCart => ({
      ...prevCart,
      coupon
    }));
  };
  
  // 清空购物车
  const clearCart = () => {
    setCart({
      items: [],
      coupon: null
    });
  };
  
  // 持久化到 localStorage
  useEffect(() => {
    localStorage.setItem('cart', JSON.stringify(cart));
  }, [cart]);
  
  return {
    cart,
    total,
    discount,
    finalTotal,
    addToCart,
    removeFromCart,
    updateQuantity,
    applyCoupon,
    clearCart
  };
}

// 使用
function ShoppingCart() {
  const {
    cart,
    total,
    discount,
    finalTotal,
    addToCart,
    removeFromCart,
    updateQuantity,
    applyCoupon,
    clearCart
  } = useShoppingCart();
  
  return (
    <div>
      <h2>购物车</h2>
      
      {cart.items.map(item => (
        <div key={item.id}>
          <h3>{item.name}</h3>
          <p>价格: ¥{item.price}</p>
          <p>数量: {item.quantity}</p>
          <button onClick={() => updateQuantity(item.id, item.quantity - 1)}>-</button>
          <button onClick={() => updateQuantity(item.id, item.quantity + 1)}>+</button>
          <button onClick={() => removeFromCart(item.id)}>删除</button>
        </div>
      ))}
      
      <div>
        <p>小计: ¥{total}</p>
        {discount > 0 && <p>折扣: -¥{discount}</p>}
        <p>总计: ¥{finalTotal}</p>
      </div>
      
      <button onClick={clearCart}>清空购物车</button>
    </div>
  );
}
```

**方案 3：Vue 3 Composition API 实现**
```javascript
import { ref, computed, watch } from 'vue';

export function useShoppingCart() {
  const cart = ref({
    items: [],
    coupon: null
  });
  
  // 计算总价
  const total = computed(() => {
    return cart.value.items.reduce((sum, item) => {
      return sum + item.price * item.quantity;
    }, 0);
  });
  
  // 计算折扣
  const discount = computed(() => {
    if (!cart.value.coupon) return 0;
    
    switch (cart.value.coupon.type) {
      case 'percentage':
        return total.value * (cart.value.coupon.value / 100);
      case 'fixed':
        return cart.value.coupon.value;
      default:
        return 0;
    }
  });
  
  // 最终价格
  const finalTotal = computed(() => total.value - discount.value);
  
  // 添加商品
  const addToCart = (product, quantity = 1) => {
    const existingItem = cart.value.items.find(item => item.id === product.id);
    
    if (existingItem) {
      existingItem.quantity += quantity;
    } else {
      cart.value.items.push({ ...product, quantity });
    }
  };
  
  // 移除商品
  const removeFromCart = (productId) => {
    cart.value.items = cart.value.items.filter(item => item.id !== productId);
  };
  
  // 更新数量
  const updateQuantity = (productId, quantity) => {
    if (quantity <= 0) {
      removeFromCart(productId);
      return;
    }
    
    const item = cart.value.items.find(item => item.id === productId);
    if (item) {
      item.quantity = quantity;
    }
  };
  
  // 应用优惠券
  const applyCoupon = (coupon) => {
    cart.value.coupon = coupon;
  };
  
  // 清空购物车
  const clearCart = () => {
    cart.value = {
      items: [],
      coupon: null
    };
  };
  
  // 持久化到 localStorage
  watch(
    cart,
    (newCart) => {
      localStorage.setItem('cart', JSON.stringify(newCart));
    },
    { deep: true }
  );
  
  return {
    cart,
    total,
    discount,
    finalTotal,
    addToCart,
    removeFromCart,
    updateQuantity,
    applyCoupon,
    clearCart
  };
}
```

**方案 4：库存管理**
```javascript
class InventoryManager {
  constructor() {
    this.inventory = new Map();
    this.reserved = new Map();
  }
  
  // 初始化库存
  initializeInventory(products) {
    products.forEach(product => {
      this.inventory.set(product.id, product.stock);
      this.reserved.set(product.id, 0);
    });
  }
  
  // 检查库存
  checkStock(productId, quantity) {
    const stock = this.inventory.get(productId) || 0;
    const reserved = this.reserved.get(productId) || 0;
    return stock - reserved >= quantity;
  }
  
  // 预留库存
  reserveStock(productId, quantity) {
    if (!this.checkStock(productId, quantity)) {
      return false;
    }
    
    const currentReserved = this.reserved.get(productId) || 0;
    this.reserved.set(productId, currentReserved + quantity);
    return true;
  }
  
  // 释放预留库存
  releaseReservedStock(productId, quantity) {
    const currentReserved = this.reserved.get(productId) || 0;
    const newReserved = Math.max(0, currentReserved - quantity);
    this.reserved.set(productId, newReserved);
  }
  
  // 扣减库存
  deductStock(productId, quantity) {
    const currentReserved = this.reserved.get(productId) || 0;
    this.reserved.set(productId, Math.max(0, currentReserved - quantity));
    
    const currentStock = this.inventory.get(productId) || 0;
    this.inventory.set(productId, Math.max(0, currentStock - quantity));
  }
  
  // 获取可用库存
  getAvailableStock(productId) {
    const stock = this.inventory.get(productId) || 0;
    const reserved = this.reserved.get(productId) || 0;
    return stock - reserved;
  }
}
```

---

## 总结

京东面试题重点掌握：

### 前端基础
1. **路由守卫**：权限控制、重定向、钩子
2. **日志系统**：日志级别、处理器、远程上报
3. **表单验证**：规则配置、错误处理
4. **图片懒加载**：Intersection Observer、性能优化
5. **购物车系统**：状态管理、价格计算、库存管理

### 算法题
1. **二分查找**：多种变体实现
2. **深拷贝**：考虑循环引用

### 场景题
1. **表单验证**：规则配置、错误处理
2. **图片懒加载**：多种实现方式、响应式图片
3. **购物车系统**：Redux、React Hooks、Vue Composition API
4. **库存管理**：预留库存、库存检查

**面试准备建议：**
1. 深入理解路由和权限控制
2. 掌握常见算法和数据结构
3. 熟悉表单验证最佳实践
4. 注重代码质量和可维护性
5. 了解电商场景的特殊需求
6. 掌握性能优化技巧
