# 4. 实现一个防抖函数，支持立即执行

**答案：**

```javascript
// 基础防抖
function debounce(fn, delay) {
  let timer = null;
  
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(this, args);
    }, delay);
  };
}

// 支持立即执行的防抖
function debounce(fn, delay, immediate = false) {
  let timer = null;
  let isInvoked = false;
  
  return function(...args) {
    const context = this;
    
    const later = () => {
      timer = null;
      if (!immediate && !isInvoked) {
        fn.apply(context, args);
      }
      isInvoked = false;
    };
    
    const callNow = immediate && !timer;
    
    clearTimeout(timer);
    timer = setTimeout(later, delay);
    
    if (callNow) {
      isInvoked = true;
      fn.apply(context, args);
    }
  };
}

// 使用示例
const debouncedSearch = debounce(function(query) {
  console.log('搜索:', query);
}, 300, false);

// 立即执行版本
const debouncedSubmit = debounce(function(data) {
  console.log('提交:', data);
}, 1000, true);

// 扩展：支持取消
function debounce(fn, delay, immediate = false) {
  let timer = null;
  let isInvoked = false;
  
  const debounced = function(...args) {
    const context = this;
    
    const later = () => {
      timer = null;
      if (!immediate && !isInvoked) {
        fn.apply(context, args);
      }
      isInvoked = false;
    };
    
    const callNow = immediate && !timer;
    
    clearTimeout(timer);
    timer = setTimeout(later, delay);
    
    if (callNow) {
      isInvoked = true;
      fn.apply(context, args);
    }
  };
  
  // 取消防抖
  debounced.cancel = function() {
    clearTimeout(timer);
    timer = null;
    isInvoked = false;
  };
  
  // 立即执行
  debounced.flush = function() {
    if (timer) {
      clearTimeout(timer);
      fn.apply(this, arguments);
    }
  };
  
  return debounced;
}

// 使用
const debounced = debounce(function() {
  console.log('执行');
}, 1000);

debounced(); // 1秒后执行
debounced.cancel(); // 取消执行

debounced.flush(); // 立即执行
```

**场景应用：**

```javascript
// 搜索框防抖
class SearchBox {
  constructor() {
    this.input = document.getElementById('search-input');
    this.debouncedSearch = debounce(this.performSearch.bind(this), 300);
    
    this.input.addEventListener('input', (e) => {
      this.debouncedSearch(e.target.value);
    });
  }
  
  async performSearch(query) {
    if (!query.trim()) {
      this.clearResults();
      return;
    }
    
    try {
      const results = await fetch(`/api/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json());
      this.displayResults(results);
    } catch (error) {
      console.error('搜索失败:', error);
    }
  }
  
  clearResults() {
    // 清空结果
  }
  
  displayResults(results) {
    // 显示结果
  }
}

// 窗口大小调整防抖
class ResponsiveLayout {
  constructor() {
    this.debouncedResize = debounce(this.handleResize.bind(this), 200);
    window.addEventListener('resize', this.debouncedResize);
    this.handleResize();
  }
  
  handleResize() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    // 根据屏幕大小调整布局
    if (width < 768) {
      this.setMobileLayout();
    } else {
      this.setDesktopLayout();
    }
  }
  
  setMobileLayout() {
    // 移动端布局
  }
  
  setDesktopLayout() {
    // 桌面端布局
  }
}

// 表单提交防抖
class FormSubmitter {
  constructor() {
    this.form = document.getElementById('my-form');
    this.debouncedSubmit = debounce(this.submitForm.bind(this), 1000, true);
    
    this.form.addEventListener('submit', (e) => {
      e.preventDefault();
      this.debouncedSubmit(new FormData(this.form));
    });
  }
  
  async submitForm(formData) {
    try {
      const response = await fetch('/api/submit', {
        method: 'POST',
        body: formData,
      });
      const result = await response.json();
      this.handleSuccess(result);
    } catch (error) {
      this.handleError(error);
    }
  }
  
  handleSuccess(result) {
    // 处理成功
  }
  
  handleError(error) {
    // 处理错误
  }
}
```

---

## 场景题
