# 2. 如何实现一个前端监控系统？

**答案：**

**监控系统架构：**

```javascript
// 1. 错误监控
class ErrorMonitor {
  constructor(config) {
    this.config = config;
    this.init();
  }
  
  init() {
    // 捕获 JavaScript 错误
    window.addEventListener('error', this.handleError.bind(this));
    
    // 捕获 Promise 错误
    window.addEventListener('unhandledrejection', this.handlePromiseError.bind(this));
    
    // 捕获资源加载错误
    window.addEventListener('error', this.handleResourceError.bind(this), true);
    
    // 捕获 Vue 错误
    if (window.Vue) {
      Vue.config.errorHandler = this.handleVueError.bind(this);
    }
    
    // 捕获 React 错误（需要 Error Boundary）
  }
  
  handleError(event) {
    this.report({
      type: 'js_error',
      message: event.message,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
      stack: event.error?.stack,
      timestamp: Date.now(),
      url: window.location.href,
      userAgent: navigator.userAgent,
    });
  }
  
  handlePromiseError(event) {
    this.report({
      type: 'promise_error',
      message: event.reason?.message,
      stack: event.reason?.stack,
      timestamp: Date.now(),
      url: window.location.href,
    });
  }
  
  handleResourceError(event) {
    if (event.target !== window) {
      this.report({
        type: 'resource_error',
        message: `资源加载失败: ${event.target.src || event.target.href}`,
        tagName: event.target.tagName,
        timestamp: Date.now(),
      });
    }
  }
  
  handleVueError(err, vm, info) {
    this.report({
      type: 'vue_error',
      message: err.message,
      stack: err.stack,
      component: vm?.$options?.name,
      info: info,
      timestamp: Date.now(),
    });
  }
  
  report(data) {
    // 上报到服务器
    fetch(this.config.reportUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    }).catch(err => console.error('上报失败:', err));
  }
}

// 使用
const monitor = new ErrorMonitor({
  reportUrl: 'https://monitor.example.com/api/error',
});

// 2. 性能监控
class PerformanceMonitor {
  constructor(config) {
    this.config = config;
    this.init();
  }
  
  init() {
    // 页面加载性能
    window.addEventListener('load', () => {
      setTimeout(() => this.measurePageLoad(), 0);
    });
    
    // 资源加载性能
    this.measureResources();
    
    // 用户行为监控
    this.trackUserBehavior();
  }
  
  measurePageLoad() {
    const perfData = performance.getEntriesByType('navigation')[0];
    
    const metrics = {
      // DNS 查询时间
      dns: perfData.domainLookupEnd - perfData.domainLookupStart,
      // TCP 连接时间
      tcp: perfData.connectEnd - perfData.connectStart,
      // 请求响应时间
      ttfb: perfData.responseStart - perfData.requestStart,
      // DOM 解析时间
      domParse: perfData.domComplete - perfData.domInteractive,
      // 资源加载时间
      resourceLoad: perfData.loadEventStart - perfData.domContentLoadedEventEnd,
      // 首屏时间
      firstPaint: this.getFirstPaint(),
      // 可交互时间
      tti: this.getTimeToInteractive(),
    };
    
    this.report({
      type: 'page_performance',
      metrics,
      timestamp: Date.now(),
      url: window.location.href,
    });
  }
  
  getFirstPaint() {
    const paintEntries = performance.getEntriesByType('paint');
    const firstPaint = paintEntries.find(entry => entry.name === 'first-paint');
    return firstPaint ? firstPaint.startTime : 0;
  }
  
  getTimeToInteractive() {
    // 使用 PerformanceObserver 监听 TTI
    return new Promise((resolve) => {
      if (window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          const entries = list.getEntries();
          const tti = entries[0]?.startTime || 0;
          resolve(tti);
        });
        observer.observe({ type: 'longtask', buffered: true });
      } else {
        resolve(0);
      }
    });
  }
  
  measureResources() {
    const resources = performance.getEntriesByType('resource');
    
    const slowResources = resources.filter(resource => {
      return resource.duration > 1000; // 超过 1 秒的慢资源
    });
    
    if (slowResources.length > 0) {
      this.report({
        type: 'slow_resources',
        resources: slowResources.map(r => ({
          name: r.name,
          duration: r.duration,
          size: r.transferSize,
        })),
        timestamp: Date.now(),
      });
    }
  }
  
  trackUserBehavior() {
    // 点击事件
    document.addEventListener('click', (e) => {
      this.report({
        type: 'click',
        target: e.target.tagName,
        className: e.target.className,
        id: e.target.id,
        timestamp: Date.now(),
      });
    });
    
    // 页面停留时间
    const startTime = Date.now();
    window.addEventListener('beforeunload', () => {
      const duration = Date.now() - startTime;
      this.report({
        type: 'page_view_duration',
        duration,
        url: window.location.href,
      });
    });
  }
  
  report(data) {
    // 使用 sendBeacon 确保页面关闭时也能上报
    if (navigator.sendBeacon) {
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      navigator.sendBeacon(this.config.reportUrl, blob);
    } else {
      fetch(this.config.reportUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
    }
  }
}

// 使用
const perfMonitor = new PerformanceMonitor({
  reportUrl: 'https://monitor.example.com/api/performance',
});
```

---

## 算法题
