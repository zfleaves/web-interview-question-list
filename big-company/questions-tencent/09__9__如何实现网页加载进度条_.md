# 9. 如何实现网页加载进度条？

**答案：**

网页加载进度条是提升用户体验的重要功能，可以让用户直观地了解页面加载进度。

**实现方案：**

**方案 1：基于 NProgress 库**
```javascript
import NProgress from 'nprogress';
import 'nprogress/nprogress.css';

// 在路由切换时显示进度条
router.beforeEach((to, from, next) => {
  NProgress.start();
  next();
});

router.afterEach(() => {
  NProgress.done();
});

// 在请求拦截器中显示进度条
axios.interceptors.request.use(config => {
  NProgress.start();
  return config;
});

axios.interceptors.response.use(response => {
  NProgress.done();
  return response;
});
```

**方案 2：基于 XMLHttpRequest 的进度监控**
```javascript
function uploadFileWithProgress(file) {
  const xhr = new XMLHttpRequest();
  const progressBar = document.getElementById('progress-bar');
  
  xhr.open('POST', '/api/upload');
  
  // 监听上传进度
  xhr.upload.onprogress = (e) => {
    if (e.lengthComputable) {
      const percentComplete = (e.loaded / e.total) * 100;
      progressBar.style.width = percentComplete + '%';
      progressBar.textContent = Math.round(percentComplete) + '%';
    }
  };
  
  xhr.onload = () => {
    progressBar.style.width = '100%';
    progressBar.textContent = '完成';
  };
  
  const formData = new FormData();
  formData.append('file', file);
  
  xhr.send(formData);
}

// 使用
uploadFileWithProgress(fileInput.files[0]);
```

**方案 3：基于 Resource Timing API 的页面加载进度**
```javascript
function trackPageLoadProgress() {
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  
  // 监听资源加载
  const resources = performance.getEntriesByType('resource');
  const totalResources = resources.length;
  let loadedResources = 0;
  
  const observer = new PerformanceObserver((list) => {
    list.getEntries().forEach(entry => {
      if (entry.entryType === 'resource') {
        loadedResources++;
        const progress = (loadedResources / totalResources) * 100;
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
        
        if (loadedResources === totalResources) {
          progressBar.style.width = '100%';
          progressText.textContent = '加载完成';
          setTimeout(() => {
            progressBar.style.opacity = '0';
          }, 500);
        }
      }
    });
  });
  
  observer.observe({ entryTypes: ['resource'] });
}

// 页面加载时启动
window.addEventListener('load', trackPageLoadProgress);
```

**方案 4：基于 Fetch API 的下载进度**
```javascript
async function downloadWithProgress(url) {
  const response = await fetch(url);
  const contentLength = response.headers.get('Content-Length');
  const total = parseInt(contentLength, 10);
  let loaded = 0;
  
  const reader = response.body.getReader();
  const progressBar = document.getElementById('progress-bar');
  
  while (true) {
    const { done, value } = await reader.read();
    
    if (done) break;
    
    loaded += value.length;
    const progress = (loaded / total) * 100;
    
    progressBar.style.width = progress + '%';
  }
  
  progressBar.textContent = '下载完成';
}
```

**方案 5：自定义进度条组件**
```javascript
function ProgressBar({ progress, color = '#1890ff' }) {
  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      width: '100%',
      height: '3px',
      backgroundColor: '#f0f0f0',
      zIndex: 9999
    }}>
      <div style={{
        width: `${progress}%`,
        height: '100%',
        backgroundColor: color,
        transition: 'width 0.3s ease'
      }} />
    </div>
  );
}

// 使用
function App() {
  const [progress, setProgress] = useState(0);
  
  useEffect(() => {
    const interval = setInterval(() => {
      setProgress(prev => {
        if (prev >= 100) {
          clearInterval(interval);
          return 100;
        }
        return prev + Math.random() * 10;
      });
    }, 100);
    
    return () => clearInterval(interval);
  }, []);
  
  return (
    <div>
      <ProgressBar progress={progress} />
      {/* 页面内容 */}
    </div>
  );
}
```

**优化技巧：**

1. **预加载关键资源**
```javascript
<link rel="preload" href="critical.css" as="style">
<link rel="preload" href="main.js" as="script">
```

2. **骨架屏替代进度条**
```javascript
function SkeletonScreen() {
  return (
    <div className="skeleton">
      <div className="skeleton-header" />
      <div className="skeleton-content" />
      <div className="skeleton-content" />
    </div>
  );
}
```

3. **分阶段显示进度**
```javascript
const stages = [
  { name: '加载样式', weight: 20 },
  { name: '加载脚本', weight: 30 },
  { name: '加载数据', weight: 50 }
];

function updateProgress(currentStage) {
  let progress = 0;
  for (let i = 0; i <= currentStage; i++) {
    progress += stages[i].weight;
  }
  progressBar.style.width = progress + '%';
}
```

---
