# 3. Vue2 的模板编译原理是什么？

**答案：**

模板编译过程：**模板 -> AST -> 渲染函数**

```javascript
// 1. 解析模板为 AST
const ast = parse(template);

// 2. 优化 AST（标记静态节点）
optimize(ast);

// 3. 生成渲染函数
const render = generate(ast);
```

**解析阶段（Parse）：**

```javascript
function parse(template) {
  const ast = {
    type: 1, // 元素节点
    tag: 'div',
    attrsList: [],
    children: []
  };
  
  // 使用正则表达式解析
  const tagReg = /^<([a-z][a-z0-9]*)/i;
  const attrReg = /\s+([a-z-]+)=(["'])(.*?)\2/i;
  
  // 解析标签
  let match = template.match(tagReg);
  if (match) {
    ast.tag = match[1];
  }
  
  // 解析属性
  while ((match = attrReg.exec(template)) !== null) {
    ast.attrsList.push({
      name: match[1],
      value: match[3]
    });
  }
  
  return ast;
}
```

**优化阶段（Optimize）：**

```javascript
function optimize(ast) {
  markStatic(ast);
}

function markStatic(node) {
  node.static = isStatic(node);
  
  if (node.children) {
    node.children.forEach(child => {
      markStatic(child);
      if (!child.static) {
        node.static = false;
      }
    });
  }
}

function isStatic(node) {
  // 静态节点：没有动态绑定、没有 v-if/v-for、没有 slot
  return !node.hasBindings && 
         !node.if && 
         !node.for && 
         !node.slotTarget;
}
```

**代码生成阶段（Generate）：**

```javascript
function generate(ast) {
  const code = ast.children.map(child => {
    if (child.type === 1) {
      return `_c('${child.tag}', ${genProps(child.attrs)}, ${genChildren(child)})`;
    } else if (child.type === 3) {
      return `_v(${JSON.stringify(child.text)})`;
    }
  }).join(',');
  
  return `with(this){return ${code}}`;
}

// 生成结果
// with(this){return _c('div',{attrs:{"id":"app"}},[_v("Hello")])}
```

**渲染函数执行：**

```javascript
// 解码后的渲染函数
function render() {
  with(this) {
    return _c('div', { attrs: { id: 'app' } }, [
      _v('Hello')
    ]);
  }
}

// _c = createElement
// _v = createTextVNode
```
