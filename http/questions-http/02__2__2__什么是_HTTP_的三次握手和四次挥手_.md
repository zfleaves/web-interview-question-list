## 2.  什么是 HTTP 的三次握手和四次挥手？

**答案：**

### 三次握手（建立连接）

三次握手是为了确认双方的接收与发送能力是否正常。

```
客户端                          服务器
   |                               |
   |-------- SYN (seq=x) --------->|  1. 客户端发送 SYN 报文
   |                               |     请求建立连接
   |                               |
   |<--- SYN+ACK (seq=y, ack=x+1) -|  2. 服务器回复 SYN+ACK
   |                               |     确认收到客户端请求
   |                               |     同时发送自己的 SYN
   |                               |
   |-------- ACK (ack=y+1) ------->|  3. 客户端发送 ACK
   |                               |     确认收到服务器的 SYN
   |                               |
   |        连接建立成功            |
```

**为什么需要三次握手？**

1. **防止已失效的连接请求报文段突然又传送到了服务器**
   - 如果只有两次握手，客户端发送的第一个连接请求在网络中滞留
   - 客户端超时重发第二个连接请求并建立连接
   - 然后第一个连接请求到达服务器，服务器误以为是新的连接请求
   - 这样就会造成资源浪费

2. **确认双方的接收和发送能力**
   - 第一次握手：服务器确认"对方发送正常"、"自己接收正常"
   - 第二次握手：客户端确认"对方发送正常"、"自己接收正常"、"对方接收正常"、"自己发送正常"
   - 第三次握手：服务器确认"对方接收正常"、"自己发送正常"

### 四次挥手（断开连接）

```
客户端                          服务器
   |                               |
   |-------- FIN (seq=u) --------->|  1. 客户端发送 FIN 报文
   |                               |     请求断开连接
   |                               |
   |<--- ACK (ack=u+1) ------------|  2. 服务器回复 ACK
   |                               |     确认收到 FIN
   |                               |     但可能还有数据要发送
   |                               |
   |<--- FIN (seq=w) ------------|  3. 服务器发送 FIN 报文
   |                               |     请求断开连接
   |                               |
   |-------- ACK (ack=w+1) ------->|  4. 客户端回复 ACK
   |                               |     确认收到 FIN
   |                               |
   |        连接断开成功            |
```

**为什么需要四次挥手？**

因为 TCP 是全双工协议，每个方向都必须单独关闭：

1. 客户端发送 FIN，表示客户端不再发送数据，但还能接收数据
2. 服务器收到 FIN 后回复 ACK，但可能还有数据要发送给客户端
3. 服务器发送完数据后，发送 FIN，表示服务器也不再发送数据
4. 客户端收到 FIN 后回复 ACK，等待 2MSL 后关闭连接

**为什么 TIME_WAIT 状态需要等待 2MSL？**

- **MSL（Maximum Segment Lifetime）**：报文最大生存时间，通常为 2 分钟
- **2MSL**：即 4 分钟

**原因：**

1. **确保最后一个 ACK 能够到达服务器**
   - 如果 ACK 丢失，服务器会重传 FIN
   - 客户端需要等待并重发 ACK

2. **确保所有旧报文消失**
   - 等待 2MSL 后，网络中所有旧的报文都会消失
   - 避免新连接收到旧连接的报文

---