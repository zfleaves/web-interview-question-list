## 6.  什么是跨域？如何解决跨域问题？

**答案：**

### 什么是跨域？

跨域是指浏览器出于安全考虑，限制从一个域名的网页去请求另一个域名的资源。

**同源策略：**

同源是指：协议、域名、端口都相同

```javascript
// 同源
http://www.example.com:80/api/users

// 不同源
http://api.example.com:80/api/users  // 域名不同
https://www.example.com:80/api/users  // 协议不同
http://www.example.com:8080/api/users // 端口不同
```

### 解决跨域的方法

#### 1. CORS（Cross-Origin Resource Sharing）- 推荐

**服务器端设置：**

```javascript
// Node.js Express
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.header('Access-Control-Allow-Credentials', 'true');
  next();
});
```

**简单请求：**

- GET、HEAD、POST
- Content-Type：text/plain、multipart/form-data、application/x-www-form-urlencoded

**复杂请求：**

- 需要先发送 OPTIONS 预检请求
- 服务器返回允许的请求方法、请求头等

#### 2. JSONP（JSON with Padding）

**原理：** 利用 `<script>` 标签没有跨域限制的特性

```javascript
// 前端
function handleResponse(data) {
  console.log(data);
}

const script = document.createElement('script');
script.src = 'http://api.example.com/data?callback=handleResponse';
document.body.appendChild(script);

// 后端（返回）
handleResponse({ name: 'test', age: 18 });
```

**缺点：**
- 只支持 GET 请求
- 存在 XSS 安全风险
- 需要服务器配合

#### 3. 代理服务器

**开发环境：**

```javascript
// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://api.example.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
}

// webpack.config.js
module.exports = {
  devServer: {
    proxy: {
      '/api': {
        target: 'http://api.example.com',
        changeOrigin: true,
        pathRewrite: { '^/api': '' }
      }
    }
  }
}
```

**生产环境：**

```nginx
# nginx 配置
location /api/ {
  proxy_pass http://api.example.com/;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
}
```

#### 4. WebSocket

WebSocket 不受同源策略限制：

```javascript
const ws = new WebSocket('ws://api.example.com');

ws.onopen = () => {
  ws.send('Hello Server');
};

ws.onmessage = (event) => {
  console.log(event.data);
};
```

#### 5. postMessage

```javascript
// 父窗口
const iframe = document.querySelector('iframe');
iframe.contentWindow.postMessage('Hello', 'http://child.example.com');

// 子窗口
window.addEventListener('message', (event) => {
  if (event.origin === 'http://parent.example.com') {
    console.log(event.data);
  }
});
```

#### 6. document.domain

只适用于子域名之间的跨域：

```javascript
// 父页面：http://parent.example.com
document.domain = 'example.com';

// 子页面：http://child.example.com
document.domain = 'example.com';
```

### CORS 跨域携带 Cookie

**前端：**

```javascript
fetch('http://api.example.com/data', {
  credentials: 'include'  // 携带 Cookie
});
```

**后端：**

```javascript
res.header('Access-Control-Allow-Origin', 'http://www.example.com');
res.header('Access-Control-Allow-Credentials', 'true');
```

**注意：** `Access-Control-Allow-Origin` 不能设置为 `*`，必须指定具体的域名。

---