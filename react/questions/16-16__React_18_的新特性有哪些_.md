# 16. React 18 的新特性有哪些？

**答案：**

React 18 引入了并发渲染和多个新特性。

**1. 自动批处理（Automatic Batching）：**

```javascript
// React 17：只有在 React 事件中才批处理
function Component() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  // ✅ 批处理：只渲染一次
  const handleClick = () => {
    setCount(c => c + 1);
    setFlag(f => !f);
    // 只渲染一次
  };

  // ❌ 不批处理：渲染两次
  const fetchData = () => {
    fetch('/api').then(() => {
      setCount(c => c + 1);  // 渲染
      setFlag(f => !f);      // 渲染
    });
  };

  return <button onClick={handleClick}>点击</button>;
}

// React 18：所有更新都会被批处理
function Component() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  // ✅ 批处理：只渲染一次
  const fetchData = () => {
    fetch('/api').then(() => {
      setCount(c => c + 1);
      setFlag(f => !f);
      // 只渲染一次
    });
  };

  return <button onClick={handleClick}>点击</button>;
}
```

**2. 并发特性（Concurrent Features）：**

```javascript
// Suspense for Data Fetching
import { Suspense } from 'react';

function App() {
  return (
    <Suspense fallback={<Loading />}>
      <UserProfile />
    </Suspense>
  );
}

// useTransition：标记非紧急更新
function Component() {
  const [isPending, startTransition] = useTransition();
  const [input, setInput] = useState('');
  const [list, setList] = useState([]);

  const handleChange = (e) => {
    // 紧急更新：立即执行
    setInput(e.target.value);
    
    // 非紧急更新：可以中断
    startTransition(() => {
      setList(filterList(e.target.value));
    });
  };

  return (
    <div>
      <input value={input} onChange={handleChange} />
      {isPending && <div>加载中...</div>}
      <List items={list} />
    </div>
  );
}

// useDeferredValue：延迟更新值
function Component() {
  const [input, setInput] = useState('');
  const deferredInput = useDeferredValue(input);

  return (
    <div>
      <input value={input} onChange={(e) => setInput(e.target.value)} />
      <ExpensiveList query={deferredInput} />
    </div>
  );
}
```

**3. 新的 Root API：**

```javascript
// React 17
import { render } from 'react-dom';
render(<App />, document.getElementById('root'));

// React 18
import { createRoot } from 'react-dom/client';
const root = createRoot(document.getElementById('root'));
root.render(<App />);

// 卸载应用
root.unmount();
```

**4. Suspense 改进：**

```javascript
// 服务端渲染支持 Suspense
import { Suspense } from 'react';

function App() {
  return (
    <Suspense fallback={<Skeleton />}>
      <Header />
      <Suspense fallback={<ContentSkeleton />}>
        <MainContent />
      </Suspense>
      <Footer />
    </Suspense>
  );
}
```

**5. 严格模式更新：**

```javascript
// React 18 严格模式：组件会挂载、卸载、再挂载
// 用于检测副作用清理逻辑
import { StrictMode } from 'react';

function App() {
  useEffect(() => {
    console.log('挂载');
    return () => {
      console.log('卸载');
    };
  }, []);

  return <div>App</div>;
}

// 开发环境下会看到两次"挂载"和"卸载"
```

**6. 新的 Hooks：**

```javascript
// useId：生成唯一 ID
function Component() {
  const id = useId();
  return (
    <div>
      <label htmlFor={`${id}-email`}>邮箱</label>
      <input id={`${id}-email`} type="email" />
    </div>
  );
}

// useSyncExternalStore：订阅外部数据源
import { useSyncExternalStore } from 'react';

function Component() {
  const width = useSyncExternalStore(
    (callback) => {
      window.addEventListener('resize', callback);
      return () => window.removeEventListener('resize', callback);
    },
    () => window.innerWidth
  );

  return <div>Width: {width}</div>;
}
```
